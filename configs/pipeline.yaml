# Unified pipeline configuration

experiment:
  name: experiment_2tx_2vars_1000ue
  output_dir: outputs
  clean: false

pipeline:
  skip_scenes: false
  skip_data: false
  skip_training: false

scenes:
  cities:
    - name: Boulder, CO
      bbox: [-105.280, 40.014, -105.270, 40.022]
      split: train_val
    - name: Austin, TX
      bbox: [-97.745, 30.265, -97.735, 30.275]
      split: test
    - name: Seattle, WA
      bbox: [-122.340, 47.605, -122.330, 47.615]
      split: train_val
    - name: Denver, CO
      bbox: [-104.995, 39.745, -104.985, 39.755]
      split: train_val
    - name: Chicago, IL
      bbox: [-87.630, 41.880, -87.620, 41.890]
      split: train_val
    - name: NYC, NY
      bbox: [-73.990, 40.750, -73.980, 40.760]
      split: train_val
  num_tx: 2
  tx_variations: 5
  site_strategy: random
  tx_height_range_m: [30.0, 45.0]
  bbox_scale: 1
  use_lidar: false
  use_dem: false
  hag_tiff_path: null

data_generation:
  carrier_frequency_hz: 3500000000.0
  bandwidth_hz: 100000000.0
  tx_power_dbm: 43.0
  noise_figure_db: 9.0
  use_mock_mode: false
  allow_mock_fallback: false
  require_sionna: true
  require_cfr: false
  max_depth: 5
  num_samples: 600000
  enable_diffraction: true
  enable_diffuse_reflection: false
  rt_batch_size: 32
  num_ue_per_tile: 1000
  ue_height_range: [1.5, 1.5]
  ue_velocity_range: [0.0, 10.0]
  num_reports_per_ue: 11
  enforce_unique_ue_positions: true
  min_ue_separation_m: 2.0
  ue_sampling_margin_m: 0.0
  max_attempts_per_ue: 3
  drop_failed_ue_trajectories: true
  rt_diagnostics_max: 20
  rt_fail_log_every: 200
  drop_log_every: 200
  drop_failed_reports: true
  max_resample_attempts: 5
  min_scene_survival_ratio: 0.4
  max_scene_resample_attempts: 3
  report_interval_ms: 200.0
  enable_k_factor: false
  enable_beam_management: true
  num_beams: 64
  max_neighbors: 8
  cfr_num_subcarriers: 64
  measurement_dropout_rates: {}
  measurement_dropout_seed: 42
  quantization_enabled: true
  max_stored_paths: 64
  max_stored_sites: 8
  use_sionna_sys: true
  num_allocated_re: 896
  bler_target: 0.1
  mcs_table_index: 1
  mcs_category: 0
  slot_duration_ms: 1.0
  log_fallback_warnings: false
  split_mode: train_val_kfold
  split_train_val_label: train_val
  kfold_num_folds: 5
  kfold_fold_index: 0
  kfold_shuffle: true
  kfold_seed: 42
  split_ratios:
    train: 0.6
    val: 0.2
    test: 0.2

model:
  radio_encoder:
    num_cells: 2
    num_beams: 64
    d_model: 96
    nhead: 4
    num_layers: 2
    dropout: 0.1
    max_seq_len: 11
    rt_features_dim: 16
    phy_features_dim: 8
    mac_features_dim: 6
  map_encoder:
    img_size: 256
    patch_size: 32
    in_channels: 10
    d_model: 128
    nhead: 4
    num_layers: 2
    dropout: 0.1
    radio_map_channels: 5
    osm_map_channels: 5
    cache_size: 16
    cache_mode: eval
  fusion:
    d_fusion: 192
    nhead: 4
    dropout: 0.1
    num_query_tokens: 2
  coarse_head:
    grid_size: 32
    d_input: 192
    dropout: 0.1
  fine_head:
    d_input: 192
    d_hidden: 192
    top_k: 3
    patch_size: 64
    use_local_map: true
    offset_scale: 1.5
    dropout: 0.1

training:
  batch_size: 32
  num_epochs: 100
  learning_rate: 0.0003
  weight_decay: 0.01
  warmup_steps: 500
  loss:
    coarse_weight: 1.5
    fine_weight: 1.0
    use_physics_loss: false
    auxiliary:
      enabled: true
      weight: 0.1
      input: radio
      tasks:
        nlos: 1.0
        num_paths: 0.5
        timing_advance: 0.5
        ta_residual: 0.3
  optimizer: adamw
  scheduler: cosine_with_warmup
  dropout: 0.1
  gradient_clip: 1.0
  gradient_clip_val: 1.0
  augmentation:
    feature_noise: 0.05
    feature_dropout: 0.1
    temporal_dropout: 0.1
    random_flip: true
    random_rotation: false
    scale_range: [1.0, 1.0]

dataset:
  train_lmdb_paths: []
  val_lmdb_paths: []
  test_lmdb_paths: []
  require_lmdb: true
  map_resolution: 1.0
  scene_extent: 512
  normalize_features: true
  handle_missing_values: mask
  split_seed: 42
  map_cache_size: 16
  sequence_length: 11
  max_cells: 2
  normalize_maps: true
  map_norm_mode: zscore
  map_log_throughput: true
  map_log_epsilon: 0.001

physics_loss:
  enabled: false
  lambda_phys: 0.05
  feature_weights:
    rsrp: 1.0
    rsrq: 0.5
    sinr: 0.8
    cqi: 0.3
    throughput: 0.2
  loss_type: huber
  huber_delta: 1.0
  normalize_features: true
  radio_maps_dir: data/radio_maps
  refinement:
    enabled: false
    num_steps: 10
    learning_rate: 0.1
    min_confidence_threshold: 0.6
    clip_to_extent: true
    coarse_logit_temperature: 1.0
    candidate_sigma_ratio: 0.05
    confidence_combine: min

evaluation:
  metrics:
    - median_error
    - rmse
    - percentile_67
    - percentile_90
    - percentile_95
    - success_rate_5m
    - success_rate_10m
  error_bins: [0, 5, 10, 20, 50, 100, 200, 500]
  viz_frequency: 5

infrastructure:
  accelerator: gpu
  devices: 1
  precision: 16-mixed
  num_workers: 8
  checkpoint:
    dirpath: checkpoints
    save_top_k: 3
    monitor: val_median_error
    mode: min
  early_stopping:
    patience: 10
    monitor: val_median_error
    mode: min
  logging:
    use_wandb: false
    use_comet: true
    project: transformer-ue-localization
    log_every_n_steps: 50

profiling:
  enabled: true
  output_dir: outputs/profiling
  sort: cumtime
  top_n: 80
  save_raw: true

seed: 42
deterministic: false
